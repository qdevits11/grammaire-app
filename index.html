<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Révision Grammaire</title>
  <link rel="stylesheet" href="style.css">
  <script>
  // Définition de la fonction checkFutur en premier
  function checkFutur(answer, game = 'futur') {
    console.log('=== FONCTION checkFutur APPELÉE ===');
    console.log('Bouton cliqué:', answer);
    
    // Attendre que l'objet games soit disponible
    if (!window.games) {
      console.error('L\'objet games n\'est pas encore chargé');
      return;
    }
    
    const gameData = window.games[game];
    if (!gameData) {
      console.error('Jeu non trouvé:', game, 'Disponibles:', Object.keys(window.games));
      return;
    }
    
    const currentData = gameData.data && gameData.data[gameData.current];
    if (!currentData) {
      console.error('Aucune donnée pour la phrase actuelle. Index:', gameData.current, 'Données:', gameData.data);
      return;
    }
    
    const feedbackElement = document.getElementById('futur-feedback');
    if (!feedbackElement) {
      console.error('Élément de feedback non trouvé');
      return;
    }
    
    console.log('Données de la phrase actuelle:', currentData);
    
    // Vérifier si la réponse est correcte
    const isCorrect = answer === currentData.auxiliaire || 
                     (answer === 'er' && currentData.auxiliaire === 'avoir') ||
                     (answer === 'ir' && currentData.auxiliaire === 'avoir');
    
    if (isCorrect) {
      console.log('Bonne réponse !');
      feedbackElement.textContent = '✅ Bonne réponse !';
      feedbackElement.style.color = 'green';
      gameData.totalPoints++;
    } else {
      console.log('Mauvaise réponse');
      feedbackElement.textContent = '❌ Mauvaise réponse !';
      feedbackElement.style.color = 'red';
      gameData.totalErreurs++;
      const sound = document.getElementById('sound-bad');
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.error('Erreur de lecture du son:', e));
      }
    }
    
    // Désactiver les boutons après une réponse
    const buttons = document.querySelectorAll('.futur-content button:not(#nextFutur)');
    console.log('Boutons trouvés:', buttons.length);
    buttons.forEach(btn => {
      btn.disabled = true;
    });
    
    // Activer le bouton suivant
    const nextButton = document.getElementById('nextFutur');
    if (nextButton) {
      nextButton.disabled = false;
    } else {
      console.error('Bouton suivant non trouvé');
    }
    
    if (window.updateScoreboard) {
      window.updateScoreboard(game);
    }
  }
  
  // Rendre la fonction disponible globalement
  window.checkFutur = checkFutur;
  
  // Fonction pour charger les données du jeu futur depuis le fichier JSON
  function loadFuturData() {
    return fetch('futur.json')
      .then(response => {
        if (!response.ok) {
          throw new Error('Erreur de chargement des données du futur');
        }
        return response.json();
      })
      .then(data => {
        console.log('Données du futur chargées:', data);
        return data.data.map(item => ({
          phrase: item.phrase,
          auxiliaire: item.type,
          correct: item.correct
        }));
      })
      .catch(error => {
        console.error('Erreur lors du chargement des données du futur:', error);
        return [];
      });
  }

  // Fonction pour initialiser les jeux
  async function initGames() {
    if (!window.games) {
      // Initialiser la structure des jeux
      window.games = {
        roles: {
          data: [],
          current: 0,
          usedIndices: [],
          réponsesCorrectes: new Set(),
          totalPoints: 0,
          totalErreurs: 0
        },
        futur: {
          data: [],
          current: 0,
          usedIndices: [],
          réponsesCorrectes: new Set(),
          totalPoints: 0,
          totalErreurs: 0
        }
      };
      
      // Charger les données du futur
      try {
        const futurData = await loadFuturData();
        if (futurData.length > 0) {
          window.games.futur.data = futurData;
          console.log('Données du jeu futur chargées avec succès');
        } else {
          console.warn('Aucune donnée chargée pour le jeu futur');
        }
      } catch (error) {
        console.error('Erreur lors du chargement des données:', error);
      }
      
      console.log('Jeux initialisés avec succès');
    }
  }
  
  // Initialiser les jeux dès que possible
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initGames().then(() => {
        // Une fois les jeux initialisés, on peut sélectionner le jeu par défaut
        if (window.selectGame) {
          window.selectGame('roles');
        }
      });
    });
  } else {
    initGames().then(() => {
      if (window.selectGame) {
        window.selectGame('roles');
      }
    });
  }
  </script>
</head>
<body>
  <div class="container">
    <button class="menu-btn" onclick="toggleMenu()">☰</button>
    <nav class="sidebar">
      <div class="logo">
        <h2>Révision Grammaire</h2>
      </div>
      <ul class="menu">
        <li class="active">
          <a href="#roles" onclick="selectGame('roles')">
            <span>🔍 Rôles des groupes</span>
          </a>
        </li>
        <li>
          <a href="#futur" onclick="selectGame('futur')">
            <span>🔮 Futur simple</span>
          </a>
        </li>
      </ul>
    </nav>
  <main class="main-content">
    <div class="top-bar">
      <div id="scoreboard">
        Points : <span id="points">0</span> | Erreurs : <span id="errors">0</span>
        <div class="stars" id="stars"></div>
      </div>
      <button onclick="resetScores()">🔄 Réinitialiser</button>
    </div>

    <div class="game-content">
      <div class="game-roles">
        <h1>Quel est le rôle de chaque groupe ?</h1>
        <div class="phrase" id="phrase">Chargement de la phrase...</div>
        <div>
          <button onclick="checkAnswer('sujet')">🔵 Sujet</button>
          <button onclick="checkAnswer('verbe')">🔴 Verbe</button>
          <button onclick="checkAnswer('cdv')">🔴 GCDV</button>
          <button onclick="checkAnswer('civ')">🔴 GCIV</button>
        </div>
        <p id="feedback"></p>
        <button id="nextBtn" onclick="nextPhrase()" disabled>👉 Phrase suivante</button>
      </div>
      <div class="game-futur" style="display: none;">
        <h1>Conjugaison au futur simple</h1>
        <div class="futur-content">
          <div class="futur-phrase" id="futur-phrase">Chargement de la phrase...</div>
          <div>
            <button onclick="checkFutur('être')">🔵 être</button>
            <button onclick="checkFutur('avoir')">🔴 avoir</button>
            <button onclick="checkFutur('er')">🔵 -er</button>
            <button onclick="checkFutur('ir')">🔴 -ir</button>
          </div>
          <p id="futur-feedback"></p>
          <button id="nextFutur" onclick="nextPhrase('futur')" disabled>👉 Phrase suivante</button>
        </div>
      </div>
    </div>
    <audio id="sound-bad" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>
  </main>


<script>
let currentGame = 'roles'; // Game par défaut
let selected = null; // Variable pour stocker le mot sélectionné
let games = {
  roles: {
    data: [],
    current: 0,
    usedIndices: [],
    réponsesCorrectes: new Set(),
    totalPoints: 0,
    totalErreurs: 0
  },
  futur: {
    data: [],
    current: 0,
    usedIndices: [],
    réponsesCorrectes: new Set(),
    totalPoints: 0,
    totalErreurs: 0
  }
};

// Charger les données des rôles depuis le fichier JSON
fetch('./data.json')
  .then(response => response.json())
  .then(rolesData => {
    if (rolesData && Array.isArray(rolesData) && rolesData.length > 0) {
      games.roles.data = rolesData;
      selectGame('roles'); // Charger le jeu par défaut après le chargement des données
    } else {
      console.error('Données des rôles invalides ou manquantes');
      document.getElementById('phrase').textContent = 'Erreur : Données des rôles manquantes.';
    }
  })
  .catch(err => {
    console.error('Erreur de chargement des données des rôles:', err);
    document.getElementById('phrase').textContent = 'Erreur : Impossible de charger les données des rôles.';
  });

// Données en dur pour le jeu futur
games.futur.data = [
  {
    phrase: "Je mangerai une pomme demain.",
    auxiliaire: "être"
  },
  {
    phrase: "Elle viendra nous voir la semaine prochaine.",
    auxiliaire: "être"
  },
  {
    phrase: "Ils travailleront toute la journée.",
    auxiliaire: "avoir"
  }
];

// Initialiser le jeu futur avec les données en dur
console.log('Initialisation du jeu futur avec les données:', games.futur.data);

// Ajouter les gestionnaires d'événements pour les boutons du futur
document.addEventListener('DOMContentLoaded', function() {
  console.log('Ajout des gestionnaires d\'événements pour les boutons du futur');
  
  // Gestionnaire pour le bouton être
  const btnEtre = document.querySelector('button[onclick*="checkFutur(\'être\')"]');
  if (btnEtre) {
    console.log('Bouton être trouvé');
    btnEtre.onclick = function() { checkFutur('être'); };
  }
  
  // Gestionnaire pour le bouton avoir
  const btnAvoir = document.querySelector('button[onclick*="checkFutur(\'avoir\')"]');
  if (btnAvoir) {
    console.log('Bouton avoir trouvé');
    btnAvoir.onclick = function() { checkFutur('avoir'); };
  }
  
  // Gestionnaire pour le bouton -er
  const btnEr = document.querySelector('button[onclick*="checkFutur(\'er\')"]');
  if (btnEr) {
    console.log('Bouton -er trouvé');
    btnEr.onclick = function() { checkFutur('er'); };
  }
  
  // Gestionnaire pour le bouton -ir
  const btnIr = document.querySelector('button[onclick*="checkFutur(\'ir\')"]');
  if (btnIr) {
    console.log('Bouton -ir trouvé');
    btnIr.onclick = function() { checkFutur('ir'); };
  }
});

// Charger le jeu par défaut (rôles)
selectGame('roles');

function selectGame(game) {
  // Mettre à jour le menu
  document.querySelectorAll('.menu li').forEach(li => {
    li.classList.remove('active');
    if (li.children[0].href.includes(`#${game}`)) {
      li.classList.add('active');
    }
  });

  // Cacher tous les jeux
  document.querySelectorAll('.game-content > div').forEach(div => {
    div.style.display = 'none';
  });

  // Afficher le jeu sélectionné
  const gameDiv = document.querySelector(`.game-${game}`);
  gameDiv.style.display = 'block';

  // Réinitialiser les scores
  resetGame(game);
}

function resetGame(game = currentGame) {
  const gameData = games[game];
  gameData.totalPoints = 0;
  gameData.totalErreurs = 0;
  gameData.usedIndices = [];
  gameData.current = 0;
  gameData.réponsesCorrectes = new Set();
  
  // Réinitialiser l'affichage selon le type de jeu
  switch(game) {
    case 'roles':
      document.getElementById('feedback').textContent = '';
      document.getElementById('nextBtn').disabled = true;
      break;
    case 'futur':
      document.getElementById('futur-feedback').textContent = '';
      document.getElementById('nextFutur').disabled = true;
      break;
  }
  
  updateScoreboard(game);
  renderPhrase(game);
}

function updateScoreboard(game = currentGame) {
  const gameData = games[game];
  document.getElementById('points').textContent = gameData.totalPoints;
  document.getElementById('errors').textContent = gameData.totalErreurs;
  const starCount = Math.floor(Math.max(0, gameData.totalPoints) / 10);
  document.getElementById('stars').textContent = '⭐'.repeat(starCount);
}

function renderPhrase(game = currentGame) {
  const gameData = games[game];
  const phraseObj = gameData.data[gameData.current];
  
  // Gérer le jeu des rôles
  if (game === 'roles') {
    const phraseTexte = phraseObj.phrase;
    let html = phraseTexte;
    document.getElementById('feedback').textContent = '';
    document.getElementById('nextBtn').disabled = true;
    gameData.réponsesCorrectes = new Set();
    selected = null;

    // Remplace chaque groupe par un <span>
    phraseObj.groupes.forEach((g, index) => {
      const escaped = g.texte.replace(/[.*+?^${}()|\\]/g, '\\$&');
      const pattern = new RegExp(escaped, 'i'); // ignore la casse
      html = html.replace(
        pattern,
        `<span class="mot" data-role="${g.role}" data-index="${index}">${g.texte}</span>`
      );
    });

    const container = document.getElementById('phrase');
    container.innerHTML = html;

    container.querySelectorAll('.mot').forEach(span => {
      span.onclick = () => {
        if (span.classList.contains('bleu') || span.classList.contains('rouge')) return;
        document.querySelectorAll('.mot').forEach(m => m.classList.remove('selected'));
        selected = span;
        span.classList.add('selected');
        document.getElementById('feedback').textContent = '';
      };
    });
  }
  // Gérer le jeu du futur simple
  else if (game === 'futur') {
    const container = document.getElementById('futur-phrase');
    container.textContent = phraseObj.phrase;
    document.getElementById('futur-feedback').textContent = '';
    document.getElementById('nextFutur').disabled = true;
  }
}

// La fonction checkFutur est maintenant définie dans le <head> pour être disponible immédiatement

function checkAnswer(answer, game = currentGame) {
  if (!selected) {
    alert("Clique sur un groupe de mots.");
    return;
  }

  const gameData = games[game];
  const role = selected.dataset.role;
  const idx = selected.dataset.index;
  selected.classList.remove('selected');

  if (answer === role) {
    selected.classList.add('bleu');
    document.getElementById('feedback').textContent = '✅ Bonne réponse !';
    gameData.réponsesCorrectes.add(idx);
    gameData.totalPoints++;
  } else {
    selected.classList.add('rouge');
    document.getElementById('feedback').textContent = ' Mauvaise réponse !';
    gameData.totalErreurs++;
    const sound = document.getElementById('sound-bad');
    sound.currentTime = 0;
    sound.play();
  }

  updateScoreboard(game);

  if (gameData.réponsesCorrectes.size === gameData.data[gameData.current].groupes.length) {
    document.getElementById('nextBtn').disabled = false;
  }
}



function nextPhrase(game = currentGame) {
  const gameData = games[game];
  
  // Réactiver les boutons de réponse
  document.querySelectorAll('.game-futur button:not(#nextFutur)').forEach(btn => {
    btn.disabled = false;
  });
  
  if (gameData.usedIndices.length === gameData.data.length) {
    // Réinitialiser les indices utilisés au lieu de réinitialiser tout le jeu
    gameData.usedIndices = [];
    gameData.current = 0;
  } else {
    let newIndex;
    do {
      newIndex = Math.floor(Math.random() * gameData.data.length);
    } while (gameData.usedIndices.includes(newIndex));

    gameData.usedIndices.push(newIndex);
    gameData.current = newIndex;
  }
  
  renderPhrase(game);
  
  // Désactiver le bouton suivant jusqu'à ce qu'une réponse soit donnée
  if (game === 'futur') {
    document.getElementById('nextFutur').disabled = true;
  } else {
    document.getElementById('nextBtn').disabled = true;
  }
}

// Fonction pour gérer le changement de jeu
function selectGame(game) {
  // Fermer le menu sur mobile/tablette
  if (window.innerWidth <= 1024) {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
      sidebar.classList.remove('active');
    }
  }

  // Mettre à jour le menu
  document.querySelectorAll('.menu li').forEach(li => {
    li.classList.remove('active');
    if (li.children[0].href.includes(`#${game}`)) {
      li.classList.add('active');
    }
  });

  // Cacher tous les jeux
  document.querySelectorAll('.game-content > div').forEach(div => {
    div.style.display = 'none';
  });

  // Afficher le jeu sélectionné
  const gameDiv = document.querySelector(`.game-${game}`);
  gameDiv.style.display = 'block';

  // Réinitialiser les scores
  resetGame(game);
}

// Fonction pour gérer le menu hamburger
function toggleMenu() {
  const sidebar = document.querySelector('.sidebar');
  const mainContent = document.querySelector('.main-content');
  const menuBtn = document.querySelector('.menu-btn');
  
  // Toggle la classe active sur la sidebar
  sidebar.classList.toggle('active');
  
  // Ajuster le margin-left du contenu principal
  mainContent.style.marginLeft = sidebar.classList.contains('active') ? '250px' : '0';
  
  // Ajuster la position du bouton menu
  menuBtn.style.left = sidebar.classList.contains('active') ? '260px' : '1rem';
}
</script>
</body>
</html>
