<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>R√©vision Grammaire</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="sidebar">
    <div class="logo">
      <h2>R√©vision Grammaire</h2>
    </div>
    <ul class="menu">
      <li class="active">
        <a href="#roles" onclick="selectGame('roles')">
          <span>üîç R√¥les des groupes</span>
        </a>
      </li>
      <li>
        <a href="#conjugaison" onclick="selectGame('conjugaison')">
          <span>üìù Conjugaison</span>
        </a>
      </li>
      <li>
        <a href="#accords" onclick="selectGame('accords')">
          <span>üîÑ Accords</span>
        </a>
      </li>
    </ul>
  </nav>

  <main class="main-content">
    <div class="top-bar">
      <div id="scoreboard">
        Points : <span id="points">0</span> | Erreurs : <span id="errors">0</span>
        <div class="stars" id="stars"></div>
      </div>
      <button onclick="resetScores()">üîÑ R√©initialiser</button>
    </div>

    <div class="game-content">
      <div class="game-roles">
        <h1>Quel est le r√¥le de chaque groupe ?</h1>
        <div class="phrase" id="phrase">Chargement de la phrase...</div>
        <div>
          <button onclick="checkAnswer('sujet')">üîµ Sujet</button>
          <button onclick="checkAnswer('verbe')">üî¥ Verbe</button>
          <button onclick="checkAnswer('cdv')">üî¥ GCDV</button>
          <button onclick="checkAnswer('civ')">üî¥ GCIV</button>
        </div>
        <p id="feedback"></p>
        <button id="nextBtn" onclick="nextPhrase()" disabled>üëâ Phrase suivante</button>
      </div>

      <div class="game-conjugaison" style="display: none;">
        <h1>Conjugaison</h1>
        <div class="conjugaison-content">
          <div class="conjugaison-info">
            <span class="verbe">Verbe : <span id="verbe">-</span></span>
            <span class="temps">Temps : <span id="temps">-</span></span>
            <span class="personne">Personne : <span id="personne">-</span></span>
          </div>
          <div class="conjugaison-input">
            <input type="text" id="conjugaison-input" placeholder="Conjuguez le verbe...">
            <button onclick="checkConjugaison()">V√©rifier</button>
          </div>
          <div id="conjugaison-feedback"></div>
          <button id="nextConjugaison" onclick="nextConjugaison()" disabled>Phrase suivante</button>
        </div>
      </div>

      <div class="game-accords" style="display: none;">
        <h1>Accords</h1>
        <div class="accords-content">
          <div class="accords-phrase" id="accords-phrase">-</div>
          <div class="accords-questions">
            <div class="question">
              <label>Le verbe est-il correctement conjugu√© ?</label>
              <div class="options">
                <label><input type="radio" name="verbe" value="oui"> Oui</label>
                <label><input type="radio" name="verbe" value="non"> Non</label>
              </div>
            </div>
            <div class="question">
              <label>Les adjectifs sont-ils correctement accord√©s ?</label>
              <div class="options">
                <label><input type="radio" name="adjectif" value="oui"> Oui</label>
                <label><input type="radio" name="adjectif" value="non"> Non</label>
              </div>
            </div>
          </div>
          <div id="accords-feedback"></div>
          <button id="checkAccords" onclick="checkAccords()" disabled>V√©rifier</button>
          <button id="nextAccords" onclick="nextAccords()" disabled>Phrase suivante</button>
        </div>
      </div>
    </div>
    <audio id="sound-bad" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>
  </main>

<script>
let currentGame = 'roles'; // Game par d√©faut
let games = {
  roles: {
    data: [],
    current: 0,
    usedIndices: [],
    r√©ponsesCorrectes: new Set(),
    totalPoints: 0,
    totalErreurs: 0
  },
  conjugaison: {
    data: [],
    current: 0,
    usedIndices: [],
    r√©ponsesCorrectes: new Set(),
    totalPoints: 0,
    totalErreurs: 0
  },
  accords: {
    data: [],
    current: 0,
    usedIndices: [],
    r√©ponsesCorrectes: new Set(),
    totalPoints: 0,
    totalErreurs: 0
  }
};

// Charger les donn√©es pour chaque jeu
Promise.all([
  fetch('./data.json').then(response => response.json()),
  fetch('./conjugaison.json').then(response => response.json()).catch(() => []),
  fetch('./accords.json').then(response => response.json()).catch(() => [])
]).then(([rolesData, conjugaisonData, accordsData]) => {
  if (rolesData && rolesData.length > 0) {
    games.roles.data = rolesData;
    games.conjugaison.data = conjugaisonData;
    games.accords.data = accordsData;
    selectGame('roles'); // Charger le jeu par d√©faut
  } else {
    document.getElementById('phrase').textContent = 'Erreur : Les donn√©es du jeu ne sont pas disponibles.';
    console.error('Donn√©es du jeu manquantes ou invalides');
  }
}).catch(err => {
  console.error('Erreur de chargement des donn√©es:', err);
  document.getElementById('phrase').textContent = 'Erreur : Impossible de charger les donn√©es du jeu.';
});

function selectGame(game) {
  // Mettre √† jour le menu
  document.querySelectorAll('.menu li').forEach(li => {
    li.classList.remove('active');
    if (li.children[0].href.includes(`#${game}`)) {
      li.classList.add('active');
    }
  });

  // Cacher tous les jeux
  document.querySelectorAll('.game-content > div').forEach(div => {
    div.style.display = 'none';
  });

  // Afficher le jeu s√©lectionn√©
  const gameDiv = document.querySelector(`.game-${game}`);
  gameDiv.style.display = 'block';

  // R√©initialiser les scores
  resetGame(game);
}

function resetGame(game = currentGame) {
  games[game].totalPoints = 0;
  games[game].totalErreurs = 0;
  games[game].usedIndices = [];
  updateScoreboard(game);
  nextPhrase(game);
}

function updateScoreboard(game = currentGame) {
  const gameData = games[game];
  document.getElementById('points').textContent = gameData.totalPoints;
  document.getElementById('errors').textContent = gameData.totalErreurs;
  const starCount = Math.floor(Math.max(0, gameData.totalPoints) / 10);
  document.getElementById('stars').textContent = '‚≠ê'.repeat(starCount);
}

function renderPhrase(game = currentGame) {
  const gameData = games[game];
  const phraseObj = gameData.data[gameData.current];
  const phraseTexte = phraseObj.phrase;
  let html = phraseTexte;
  document.getElementById('feedback').textContent = '';
  document.getElementById('nextBtn').disabled = true;
  gameData.r√©ponsesCorrectes = new Set();
  selected = null;

  // Remplace chaque groupe par un <span>
  phraseObj.groupes.forEach((g, index) => {
    const escaped = g.texte.replace(/[.*+?^${}()|\\]/g, '\\$&');
    const pattern = new RegExp(escaped, 'i'); // ignore la casse
    html = html.replace(
      pattern,
      `<span class="mot" data-role="${g.role}" data-index="${index}">${g.texte}</span>`
    );
  });

  const container = document.getElementById('phrase');
  container.innerHTML = html;

  container.querySelectorAll('.mot').forEach(span => {
    span.onclick = () => {
      if (span.classList.contains('bleu') || span.classList.contains('rouge')) return;
      document.querySelectorAll('.mot').forEach(m => m.classList.remove('selected'));
      selected = span;
      span.classList.add('selected');
      document.getElementById('feedback').textContent = '';
    };
  });
}

function checkAnswer(answer, game = currentGame) {
  if (!selected) {
    alert("Clique sur un groupe de mots.");
    return;
  }

  const gameData = games[game];
  const role = selected.dataset.role;
  const idx = selected.dataset.index;
  selected.classList.remove('selected');

  if (answer === role) {
    selected.classList.add('bleu');
    document.getElementById('feedback').textContent = '‚úÖ Bonne r√©ponse !';
    gameData.r√©ponsesCorrectes.add(idx);
    gameData.totalPoints++;
  } else {
    selected.classList.add('rouge');
    document.getElementById('feedback').textContent = ' Mauvaise r√©ponse !';
    gameData.totalErreurs++;
    const sound = document.getElementById('sound-bad');
    sound.currentTime = 0;
    sound.play();
  }

  updateScoreboard(game);

  if (gameData.r√©ponsesCorrectes.size === gameData.data[gameData.current].groupes.length) {
    document.getElementById('nextBtn').disabled = false;
  }
}

function checkConjugaison() {
  const input = document.getElementById('conjugaison-input').value.trim().toLowerCase();
  const gameData = games.conjugaison;
  const correct = gameData.data[gameData.current].correct.toLowerCase();

  if (input === correct) {
    document.getElementById('conjugaison-feedback').textContent = ' Bonne r√©ponse !';
    gameData.totalPoints++;
    document.getElementById('nextConjugaison').disabled = false;
  } else {
    document.getElementById('conjugaison-feedback').textContent = ' Mauvaise r√©ponse ! La bonne r√©ponse √©tait : ' + correct;
    gameData.totalErreurs++;
    document.getElementById('sound-bad').play();
  }
  updateScoreboard('conjugaison');
}

function checkAccords() {
  const gameData = games.accords;
  const currentData = gameData.data[gameData.current];
  let correct = true;
  let feedback = '';

  // V√©rifier le verbe
  const verbeCorrect = document.querySelector('input[name="verbe"]:checked').value === 'oui';
  const verbeExpected = currentData.accords.some(a => a.type === 'verbe' && a.correct);
  if (verbeCorrect !== verbeExpected) {
    correct = false;
    feedback += ' Erreur sur l\'accord du verbe. ';
  }

  // V√©rifier les adjectifs
  const adjectifCorrect = document.querySelector('input[name="adjectif"]:checked').value === 'oui';
  const adjectifExpected = currentData.accords.some(a => a.type === 'adjectif' && a.correct);
  if (adjectifCorrect !== adjectifExpected) {
    correct = false;
    feedback += ' Erreur sur l\'accord de l\'adjectif. ';
  }

  if (correct) {
    feedback = ' Bonne r√©ponse ! Tous les accords sont corrects.';
    gameData.totalPoints++;
    document.getElementById('nextAccords').disabled = false;
  } else {
    feedback += '\nLes explications des accords corrects sont :\n' +
                currentData.accords.map(a => `- ${a.explication}`).join('\n');
    gameData.totalErreurs++;
    document.getElementById('sound-bad').play();
  }

  document.getElementById('accords-feedback').textContent = feedback;
  updateScoreboard('accords');
}

function nextConjugaison() {
  const gameData = games.conjugaison;
  const current = gameData.current;
  
  // Trouver un nouvel index non utilis√©
  let newIndex;
  do {
    newIndex = Math.floor(Math.random() * gameData.data.length);
  } while (gameData.usedIndices.includes(newIndex));

  gameData.current = newIndex;
  gameData.usedIndices.push(newIndex);
  gameData.r√©ponsesCorrectes = new Set();

  // Mettre √† jour l'affichage
  const conjugaisonData = gameData.data[newIndex];
  document.getElementById('verbe').textContent = conjugaisonData.verbe;
  document.getElementById('temps').textContent = conjugaisonData.temps;
  document.getElementById('personne').textContent = conjugaisonData.personne;
  document.getElementById('conjugaison-input').value = '';
  document.getElementById('conjugaison-feedback').textContent = '';
  document.getElementById('nextConjugaison').disabled = true;

  // R√©initialiser si tous les indices ont √©t√© utilis√©s
  if (gameData.usedIndices.length >= gameData.data.length) {
    gameData.usedIndices = [];
  }
}

function nextAccords() {
  const gameData = games.accords;
  const current = gameData.current;
  
  // Trouver un nouvel index non utilis√©
  let newIndex;
  do {
    newIndex = Math.floor(Math.random() * gameData.data.length);
  } while (gameData.usedIndices.includes(newIndex));

  gameData.current = newIndex;
  gameData.usedIndices.push(newIndex);
  gameData.r√©ponsesCorrectes = new Set();

  // Mettre √† jour l'affichage
  const accordsData = gameData.data[newIndex];
  document.getElementById('accords-phrase').textContent = accordsData.phrase;
  document.getElementById('accords-feedback').textContent = '';
  document.getElementById('checkAccords').disabled = true;
  document.getElementById('nextAccords').disabled = true;
  
  // R√©initialiser les radios
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });

  // R√©initialiser si tous les indices ont √©t√© utilis√©s
  if (gameData.usedIndices.length >= gameData.data.length) {
    gameData.usedIndices = [];
  }
}

function nextPhrase(game = currentGame) {
  const gameData = games[game];
  if (gameData.usedIndices.length === gameData.data.length) {
    // R√©initialiser les indices utilis√©s au lieu de r√©initialiser tout le jeu
    gameData.usedIndices = [];
    gameData.current = 0;
    renderPhrase(game);
    return;
  }

  let newIndex;
  do {
    newIndex = Math.floor(Math.random() * gameData.data.length);
  } while (gameData.usedIndices.includes(newIndex));

  gameData.usedIndices.push(newIndex);
  gameData.current = newIndex;
  renderPhrase(game);
}

// Fonction pour g√©rer le changement de jeu
window.selectGame = selectGame;
</script>
</body>
</html>
