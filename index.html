<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RÃ©vision Grammaire</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="sidebar">
    <div class="logo">
      <h2>RÃ©vision Grammaire</h2>
    </div>
    <ul class="menu">
      <li class="active">
        <a href="#roles" onclick="selectGame('roles')">
          <span>ğŸ” RÃ´les des groupes</span>
        </a>
      </li>
      <li>
        <a href="#conjugaison" onclick="selectGame('conjugaison')">
          <span>ğŸ“ Conjugaison</span>
        </a>
      </li>
      <li>
        <a href="#accords" onclick="selectGame('accords')">
          <span>ğŸ”„ Accords</span>
        </a>
      </li>
    </ul>
  </nav>

  <main class="main-content">
    <div class="top-bar">
      <div id="scoreboard">
        Points : <span id="points">0</span> | Erreurs : <span id="errors">0</span>
        <div class="stars" id="stars"></div>
      </div>
      <button onclick="resetScores()">ğŸ”„ RÃ©initialiser</button>
    </div>

    <div class="game-content">
      <div class="game-roles">
        <h1>Quel est le rÃ´le de chaque groupe ?</h1>
        <div class="phrase" id="phrase">Chargement de la phrase...</div>
        <div>
          <button onclick="checkAnswer('sujet')">ğŸ”µ Sujet</button>
          <button onclick="checkAnswer('verbe')">ğŸ”´ Verbe</button>
          <button onclick="checkAnswer('cdv')">ğŸ”´ GCDV</button>
          <button onclick="checkAnswer('civ')">ğŸ”´ GCIV</button>
        </div>
        <p id="feedback"></p>
        <button id="nextBtn" onclick="nextPhrase()" disabled>ğŸ‘‰ Phrase suivante</button>
      </div>

      <div class="game-conjugaison" style="display: none;">
        <h1>Conjugaison</h1>
        <p>Contenu du jeu de conjugaison Ã  venir...</p>
      </div>

      <div class="game-accords" style="display: none;">
        <h1>Accords</h1>
        <p>Contenu du jeu d'accords Ã  venir...</p>
      </div>
    </div>
    <audio id="sound-bad" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>
  </main>

<script>
let phrases = [];
let current = 0;
let selected = null;
let usedIndices = [];
let rÃ©ponsesCorrectes = new Set();
let totalPoints = 0;
let totalErreurs = 0;

fetch('./data.json')
  .then(response => response.json())
  .then(data => {
    phrases = data;
    nextPhrase();
  })
  .catch(err => {
    document.getElementById('phrase').textContent = "Erreur de chargement du fichier JSON";
    console.error(err);
  });

function renderPhrase() {
  const phraseObj = phrases[current];
  const phraseTexte = phraseObj.phrase;
  let html = phraseTexte;
  document.getElementById('feedback').textContent = '';
  document.getElementById('nextBtn').disabled = true;
  rÃ©ponsesCorrectes = new Set();
  selected = null;

  // Remplace chaque groupe par un <span>
  phraseObj.groupes.forEach((g, index) => {
    const escaped = g.texte.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const pattern = new RegExp(escaped, 'i'); // ignore la casse
    html = html.replace(
      pattern,
      `<span class="mot" data-role="${g.role}" data-index="${index}">${g.texte}</span>`
    );
  });

  const container = document.getElementById('phrase');
  container.innerHTML = html;

  container.querySelectorAll('.mot').forEach(span => {
    span.onclick = () => {
      if (span.classList.contains('bleu') || span.classList.contains('rouge')) return;
      document.querySelectorAll('.mot').forEach(m => m.classList.remove('selected'));
      selected = span;
      span.classList.add('selected');
      document.getElementById('feedback').textContent = '';
    };
  });
}

function updateScoreboard() {
  document.getElementById('points').textContent = totalPoints;
  document.getElementById('errors').textContent = totalErreurs;
  const starCount = Math.floor(Math.max(0, totalPoints) / 10);
  document.getElementById('stars').textContent = 'â­'.repeat(starCount);
}

function checkAnswer(answer) {
  if (!selected) {
    alert("Clique sur un groupe de mots.");
    return;
  }

  const role = selected.dataset.role;
  const idx = selected.dataset.index;
  selected.classList.remove('selected');

  if (role === answer) {
    selected.classList.add(role === 'sujet' ? 'bleu' : 'rouge');
    rÃ©ponsesCorrectes.add(idx);
    totalPoints++;
    updateScoreboard();
  } else {
    totalErreurs++;
    totalPoints--;
    document.getElementById('sound-bad').play();
    updateScoreboard();
    document.getElementById('feedback').textContent = `âŒ Mauvaise rÃ©ponse.`;
    return;
  }

  const total = phrases[current].groupes.length;
  if (rÃ©ponsesCorrectes.size === total) {
    document.getElementById('feedback').textContent = `âœ… Bravo ! Tu as tout trouvÃ©.`;
    document.getElementById('nextBtn').disabled = false;
  }
}

function nextPhrase() {
  if (usedIndices.length === phrases.length) usedIndices = [];

  let index;
  do {
    index = Math.floor(Math.random() * phrases.length);
  } while (usedIndices.includes(index));

  usedIndices.push(index);
  current = index;
  renderPhrase();
}

function resetScores() {
  totalPoints = 0;
  totalErreurs = 0;
  updateScoreboard();
}
</script>
</body>
</html>
